使用缓存的时候，我们经常需要对内存中的数据进行持久化也就是将内存中的数据写到硬盘中。大部分原因是为了重用数据，或者是为了做数据同步。
redis不同于memcached的很重要一定就是，redis支持持久化，而且支持3中持久化方式：
- 快照（snapshotting RDB）
- 之追加文件（append-only file，AOF）
- RDB和AOF的混合持久化

### RDB持久化
#### 什么是rdb持久化
redis可以通过快照来获得存储在内存里面的数据在某个时间点上的副本。redis创建快照之后，可以对快照进行备份，可以将快照复制到其他服务器从而创建具有相同数据的服务器副本，还可以将快照留在原地一遍重启服务器的时候使用。
#### RDB创建快照是会阻塞主线程吗
redis提供了两个命令来生成RDB快照文件：
- save ：同步操作，会阻塞redis主线程；
- bgsave：fork出一个紫禁城，紫禁城执行，不会阻塞redis主线程，默认选项。

### AOF持久化
#### 什么是AOF持久化
与快照持久化相比，AOF持久化的实时性更好。默认情况下redis没有开启AOF方式的持久化，可以通过appendonly参数开启  appendonly yes
开启AOF持久化后每执行一条会更改redis中的数据的命令，redis就会将该命令写入到aof缓冲区server.aof_buf中，然后再写入到aof文件中，最后再根据持久化方式的配置来决定何时将系统内核缓存区的数据同步到硬盘的。

只有同步到磁盘中才算持久化保存了，否则依然存在数据丢失的风险，比如说：系统内核缓存区的数据还未同步，磁盘机器就宕机了，那这部分数据就算丢失了。

#### aof工作基本流程是怎样的
aof持久化功能的实现可以简单分为5步：
1. 命令追加(append)：所有的写命令最佳到aof缓冲区中、
2. 文件写入（write）：将aof缓冲区的数据写入到aof文件中。这一步需要调用write函数，write将数据写入到系统内核缓冲区之后直接返回
3. 文件同步：aof缓冲区根据对应的持久化方式像硬盘做同步操作。这一步需要调用fsync函数，fsync只对单个文件操作，对其进行强制硬盘同步，fsync将阻塞直接写入磁盘完成后返回，保证了数据持久化。
4. 文件重写：随着aof文件越来越大，需要定期对aof文件进行重写，达到压缩的目的。
5. 重启加载：但redis重启是，可以加载aof文件进行数据恢复。

#### aof持久化方式有哪些
在redis的配置文件中存在一种不同的aof持久化方式，他们分别是
1. appendfsync always：主线程调用write执行写操作后，后台线程立即会滴啊用fsync函数同步aof文件，fsync完成后线程返回，这样会严重降低redis的性能。（`write` + `fsync`）。
2. appendsync everysec：主线程调用write执行操作后离职返回，由后台线程每秒钟调用fsync函数同步一次aof文件（`write`+`fsync`，`fsync`间隔为 1 秒）
3. appendfsync no：主线程调用write执行写操作后立即返回，让操作系统决定何时进行同步，linux下一般为30s一次（`write`但不`fsync`，`fsync` 的时机由操作系统决定）。
可以看出：这3中持久化方式的主要区别在于fsync同步aof文件的时机。
为了兼顾数据和写入性能，可以考虑 `appendfsync everysec` 选项 ，让 Redis 每秒同步一次 AOF 文件，Redis 性能受到的影响较小。而且这样即使出现系统崩溃，用户最多只会丢失一秒之内产生的数据。当硬盘忙于执行写入操作的时候，Redis 还会优雅的放慢自己的速度以便适应硬盘的最大写入速度。
#### aof为什么是在执行完命令之后记录日志
关系型数据库通常都是执行命令之前记录入职，而redis aof持久化机制是在执行完命令之后在记录日志。![[Pasted image 20231207112828.png]]
为什么是在执行完命令之后记录日志呢。
- 避免额外的检查开销，aof记录日志不会对命令进行语法检查
- 在命令执行完之后在记录，不会阻塞当前的命令执行。
这样也带来了风险：
- 如果刚执行完命令redis就宕机会导致对应的修改丢失
- 可能会阻塞后续其他命令的执行
#### ao重写
当aof变得太大时，redis能够在后台自动重写aof产生一个新的aof文件，这个新的aof文件和原有aof文件说保存的数据库状态一样，但体积更小。![[Pasted image 20231207113242.png]]
由于aof重写会进行大量的写入操作，为了避免对redis正常处理命令请求造成影响，redis将aof重写程序放到子进程里执行。
aof文件重写期间，redis还会维护一个aof重写缓冲区，该缓冲区会在子进程创建新的aof文件期间，记录服务器执行的所有写命令。当子进程完成创建新的aof文件的工作之后，服务器会将重写缓冲区的所有内容追加到新的aof文件的末尾，使得新的aof文件保存的数据库状态与现有的数据库状态一致。最后，服务器用新的aof文件替换旧的aof文件，以此来完成aof文件重写操作。

开启aof重写功能，可以调用`BGREWRITEAOF`命令手动执行，也可以设置下面两个配置项，让程序自动决定出发时机：
- auto-aof-rewrite-min-size：如果aof文件大小小于改制，则不会触发aof重写。默认为64mb。
- auto-aof-rewrite-percentage：执行aof重写时，当前aof带下和上一次重写是aof大小的壁纸。如果当前aof文件大小增加这个百分比值，将触发aof重写。将此值设置为0将禁用自动aof重写。默认值为100。

#### aof校验机制
OF 校验机制是 Redis 在启动时对 AOF 文件进行检查，以判断文件是否完整，是否有损坏或者丢失的数据。这个机制的原理其实非常简单，就是通过使用一种叫做 **校验和（checksum）** 的数字来验证 AOF 文件。这个校验和是通过对整个 AOF 文件内容进行 CRC64 算法计算得出的数字。如果文件内容发生了变化，那么校验和也会随之改变。因此，Redis 在启动时会比较计算出的校验和与文件末尾保存的校验和（计算的时候会把最后一行保存校验和的内容给忽略点），从而判断 AOF 文件是否完整。如果发现文件有问题，Redis 就会拒绝启动并提供相应的错误信息。AOF 校验机制十分简单有效，可以提高 Redis 数据的可靠性。
