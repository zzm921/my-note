为了准确无误的把数据送达目的地，TCP协议采用了三次握手策略。
### 建立连接-TCP三次握手
1.客户端发送含有syn（seq=x）标识的数据包到服务器。
2.服务器收到后发送ack+syn标识的数据包到客户端。
3.客户端收到后发送ack到服务器，建立连接。
![[Pasted image 20240116152319.png]]
建立一个TCP连接需要“三次握手”，缺一不可：
- 第一次握手：客户端发送SYN(SEQ=x)标志的数据包到服务端，然后客户端进入SYN_SEND状态，等待服务器响应。
- 第二次握手：服务端发送SYN+ACK（SEQ=y，ACK=x+1）标志的数据包到客户端，然后服务端进入SYN_RECV状态
- 第三次握手：客户端发送带有ACK（ACK=y+1）标志的数据包到服务器，然后客户端和服务器都进入ESTABLISHED状态，完成TCP三次握手。

#### 为什么要三次握手
三次握手的目的是建立可靠的通信信道，双方要确认自己与对方发送和接收都是正常的。
1. 第一次握手：client什么都不能确认，服务端确认对方发送正常，自己接收正常。
2. 第二次握手：客户端确认自己发送正常，接收正常，对方发送正常、接收正常。服务端确认对方发送正常，自己接收正常。
3. 第三次握手：Client 确认了：自己发送、接收正常，对方发送、接收正常；Server 确认了：自己发送、接收正常，对方发送、接收正常
#### 第二次握手回传了ACK，为什么还要回传SYN？
服务端回传ACK是为了告诉客户端：我接收到的信息确实是你说发送的信息。这表明从客户端到服务器的通信是正常的。回传SYN是为了确认从服务器到客户端的通信是否正常。

	SYN 同步序列编号(Synchronize Sequence Numbers) 是 TCP/IP 建立连接时使用的握手信号。在客户机和服务器之间建立正常的 TCP 网络连接时，客户机首先发出一个 SYN 消息，服务器使用 SYN-ACK 应答表示接收到了这个消息，最后客户机再以 ACK(Acknowledgement）消息响应。这样在客户机和服务器之间才能建立起可靠的 TCP 连接，数据才可以在客户机和服务器之间传递。

### 断开连接-TCP四次挥手
1.客户端发送包含fin标识的数据包
2.服务端收到后发送ack标识的数据包到客户端
3.服务器发送fin标识的数据包到客户端
4.客户端发送ack标识的数据包到服务端
![[Pasted image 20240116153958.png]]
断开TCP连接需要四次挥手，缺一不可
1. 第一次挥手：客服端发送一个FIN(SEQ=x)标志的数据包到服务端，用来关闭客户端到服务器的数据传送，然后客户端进入FIN-WAIT-1状态。
2. 第二次挥手：服务端发送一个ACK（ACK=x+1）标识的数据包到客户端。然后服务端进入CLOSE-WAIT状态，客户端进入FIN-WAIT-2状态。
3. 第三次挥手：服务端发送一个FIN（SEQ=y）标志的数据包到客户端。请求关闭连接，然后服务端进入LAST-ACK状态
4. 死四次挥手：客户端发送ACK（ACK=y+1）标志的数据包到服务端，然后客户端进入TIME-WAIT状态，服务端在收到ACK标识的数据包后进入CLOSE状态。喜事如果客户端等待2NSL后依然没有收到回复，就证明服务端已经正常关闭，随后客户端也可以关闭连接了。
**只要四次挥手没有结束，客户端和服务端就可以继续传输数据！**
#### 为什么要四次挥手
TCP是双全工通信，可以双向传输数据。任何一方都可以在数据传送结束后发出连接释放的通知，待对方确认后进入半关闭装填。当另一方也没有数据在发送的时候，则发出连接释放通知，对方确认后就完全关闭了TCP连接。

####  为什么不能把服务器发送的 ACK 和 FIN 合并起来，变成三次挥手？
因为服务器收到客户端断开连接的请求时，可能还有一些数据没有发完，这时先回复 ACK，表示接收到了断开连接的请求。等到数据发完之后再发 FIN，断开服务器到客户端的数据传送。

#### 如果第二次挥手时服务器的 ACK 没有送达客户端，会怎样？
客户端没有收到 ACK 确认，会重新发送 FIN 请求。

#### 为什么第四次挥手客户端需要等待 2*MSL（报文段最长寿命）时间后才进入 CLOSED 状态？

第四次挥手时，客户端放给服务器的ACK可能会丢失，如果服务端没有收到ACK的话，服务端就会重发FIN，如果客户端在2MSL的时间内收到FIN，就会重新发送ACK并再次等待，防止Server没有收到ACK而不断重发FIN。
	**MSL(Maximum Segment Lifetime)** : 一个片段在网络中最大的存活时间，2MSL 就是一个发送和一个回复所需的最大时间。如果直到 2MSL，Client 都没有再次收到 FIN，那么 Client 推断 ACK 已经被成功接收，则结束 TCP 连接。

