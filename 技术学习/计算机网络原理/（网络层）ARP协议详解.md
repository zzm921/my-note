每当我们学习一个新的网络协议的时候，都要把他结合到 OSI 七层模型中，或者是 TCP/IP 协议栈中来学习，一是要学习该协议在整个网络协议栈中的位置，二是要学习该协议解决了什么问题，地位如何？三是要学习该协议的工作原理，以及一些更深入的细节。
**ARP 协议**，可以说是在协议栈中属于一个**偏底层的、非常重要的、又非常简单的**通信协议。
开始阅读这篇文章之前，你可以先看看下面几个问题：
1. **ARP 协议在协议栈中的位置？** ARP 协议在协议栈中的位置非常重要，在理解了它的工作原理之后，也很难说它到底是网络层协议，还是链路层协议，因为它恰恰串联起了网络层和链路层。国外的大部分教程通常将 ARP 协议放在网络层。
2. **ARP 协议解决了什么问题，地位如何？** ARP 协议，全称 **地址解析协议（Address Resolution Protocol）**，它解决的是网络层地址和链路层地址之间的转换问题。因为一个 IP 数据报在物理上传输的过程中，总是需要知道下一跳（物理上的下一个目的地）该去往何处，但 IP 地址属于逻辑地址，而 MAC 地址才是物理地址，ARP 协议解决了 IP 地址转 MAC 地址的一些问题。
3. **ARP 工作原理？** 只希望大家记住几个关键词：**ARP 表、广播问询、单播响应**。


### ARP 协议工作原理
ARP协议工作时有一个大前提，那就是ARP表。
在一个局域网内，每个网络设备都自己维护了一个ARP表，ARP表记录了某些其他网络设备的IP地址-MAC地址映射关系，该映射关系已<IP ,MAC,TTL>三元组的形式存储。其中，TTL为该映射关系的生存周期，典型值为20分钟，超过改时间，该条目将被丢弃。

ARP的工作原理将分两种场景讨论：
1. 同一局域网内的MAC寻址
2. 从一个局域网到另一个局域网中的网络设备的寻址。

#### 同一局域网内MAC寻址
假设当前有如下场景：IP 地址为`137.196.7.23`的主机 A，想要给同一局域网内的 IP 地址为`137.196.7.14`主机 B，发送 IP 数据报文。
	再次强调，当主机发送 IP 数据报文时（网络层），仅知道目的地的 IP 地址，并不清楚目的地的 MAC 地址，而 ARP 协议就是解决这一问题的。
为了达成这一目标，主机A将不得不通过ARP协议来获取主机B的MAC地址，并将IP保温封装成链路层帧，发送到下一跳上。在该局域网内，关于此将按照时间顺序，一次发生如下事件：
1. 主机A检索自己的ARP表，发现ARP表中并无主机IP地址对应的映射条目，也就无从知道主机B的MAC地址。
2. 主机A将构造一个ARP查询分组，并将其广播到所在的局域网中。
	 ARP分组是一种特殊保温，ARP分组有两类，一种是查询分组，另一种是相应分组，他们具有相同的格式，均包含了发送和接收的IP地址、发送和吉首的MAC地址。当然了，查询分组中，发送的IP地址，即为主机A的IP地址，接收的IP地址即为主机B的IP地址，发送的MAC地址也是主机A的MAC地址，但接收的MAC地址绝不会是主机B的MAC地址，而是一个特殊值——`F-FF-FF-FF-FF-FF`，之前说过，该 MAC 地址是广播地址，也就是说，查询分组将广播给该局域网内的所有设备。
3. 主机A构造的查询分组将在该局域网内广播，理论上，每一个设备都会收到该分组，并检查查询分组的接受IP地址是否是自己的IP地址，如果是，说明查询分组已经到达了主机B，否则，该查询分组对当前设备无效，丢弃之。
4. 主机B收到了查询分组之后，验证是对自己的问询，接着构造一个ARP相应分组，该分组的目的地只有一个——主机A。同时，主机B提取查询分组中的IP地址和MAC地址信息，在自己的ARP表中构造一条主机A的IP-MAC映射记录。
	 - ARP 响应分组具有和 ARP 查询分组相同的构造，不同的是，发送和接受的 IP 地址恰恰相反，发送的 MAC 地址为发送者本身，目标 MAC 地址为查询分组的发送者，也就是说，ARP 响应分组只有一个目的地，而非广播。
5. 主机A终将收到主机B的相应分组，提取该分组中的IP地址和MAC地址后，构造映射信息，加入到自己的ARP表中。
![[Pasted image 20240117170524.png]]
在整个过程中，有几点需要补充说明的是：
1. 主机 A 想要给主机 B 发送 IP 数据报，如果主机 B 的 IP-MAC 映射信息已经存在于主机 A 的 ARP 表中，那么主机 A 无需广播，只需提取 MAC 地址并构造链路层帧发送即可。
2. ARP 表中的映射信息是有生存周期的，典型值为 20 分钟。
3. 目标主机接收到了问询主机构造的问询报文后，将先把问询主机的 IP-MAC 映射存进自己的 ARP 表中，这样才能获取到响应的目标 MAC 地址，顺利的发送响应分组。

总结来说，ARP 协议是一个**广播问询，单播响应**协议。

#### 不同局域网内的MAC寻址
更复杂的情况是，发送主机A和接收主机B不在同一个子网中，假设一个一般场景，两台主机所在的子网由一台路由器联通。